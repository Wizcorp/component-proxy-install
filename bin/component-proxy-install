#!/usr/bin/env node
var app = require('../');
var spawn = require('child_process').spawn;

// Get the path of the loaded file for the `component` module
var componentPath = require.resolve('component');
// Now, we must have a string like /path/to/the/component/node_modules/probably/some/directories/index.js
// We want to get the deeper `node_modules` directory and access to the `.bin` directory it contains
var componentPathSeeker = new RegExp('(.*/node_modules/).*?');
var componentBinaryPath = componentPathSeeker.exec(componentPath)[1] + '.bin/component';

// Run the server
console.log('Starting component proxy');
app.start();

var port = app.getPort();

var installArgs = [ 'install', '-r', 'https://raw.githubusercontent.com,http://127.0.0.1:' + port ];
installArgs = installArgs.concat(process.argv.slice(2));

// Run the install process
var installProc = spawn(componentBinaryPath, installArgs);

installProc.stdout.on('data', function(data) {
  process.stdout.write('' + data);
});

installProc.stderr.on('data', function(data) {
  process.stderr.write('' + data);
});

installProc.on('close', function(code) {
  console.log('Stopping component proxy');
  app.stop(function () {
    process.exit(code);
  });
});
